<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shapira Apartment - 3D Mockup</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Segoe UI', system-ui, sans-serif; overflow: hidden; background: #1a1a2e; color: #e0e0e0; }
  #canvas-container { width: 100vw; height: 100vh; }
  canvas { display: block; }
  #panel {
    position: fixed; left: 0; top: 0; width: 320px; height: 100vh;
    background: rgba(20,20,40,0.95); backdrop-filter: blur(12px);
    border-right: 1px solid rgba(255,255,255,0.1);
    overflow-y: auto; z-index: 100; transition: transform 0.3s; padding: 16px;
  }
  #panel.collapsed { transform: translateX(-320px); }
  #toggle-panel {
    position: fixed; left: 320px; top: 12px; z-index: 101;
    background: rgba(20,20,40,0.9); border: 1px solid rgba(255,255,255,0.15);
    color: #fff; width: 36px; height: 36px; border-radius: 0 8px 8px 0;
    cursor: pointer; font-size: 18px; transition: left 0.3s;
    display: flex; align-items: center; justify-content: center;
  }
  #toggle-panel.collapsed { left: 0; }
  .panel-section { margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid rgba(255,255,255,0.08); }
  .panel-section:last-child { border-bottom: none; }
  h2 { font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 1.2px; color: #8b8bbd; margin-bottom: 12px; }
  h1 { font-size: 18px; font-weight: 700; color: #fff; margin-bottom: 4px; }
  .subtitle { font-size: 12px; color: #666; margin-bottom: 16px; }
  .room-btn {
    display: block; width: 100%; padding: 10px 14px; margin-bottom: 6px;
    background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px; color: #ccc; font-size: 13px; cursor: pointer; text-align: right; transition: all 0.2s;
  }
  .room-btn:hover { background: rgba(255,255,255,0.1); }
  .room-btn.active { background: rgba(99,102,241,0.2); border-color: rgba(99,102,241,0.5); color: #a5b4fc; }
  .room-btn .dims { font-size: 11px; color: #666; display: block; margin-top: 2px; }
  .color-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; margin-bottom: 10px; }
  .color-swatch { width: 100%; aspect-ratio: 1; border-radius: 6px; cursor: pointer; border: 2px solid transparent; transition: all 0.15s; }
  .color-swatch:hover { transform: scale(1.15); box-shadow: 0 2px 8px rgba(0,0,0,0.4); }
  .color-swatch.active { border-color: #fff; box-shadow: 0 0 0 2px rgba(99,102,241,0.5); }
  .custom-color { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
  .custom-color input[type="color"] { width: 36px; height: 30px; border: none; border-radius: 4px; cursor: pointer; background: none; }
  .custom-color label { font-size: 12px; color: #888; }
  .furniture-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 12px; margin-bottom: 4px; background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.06); border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 13px;
  }
  .furniture-item:hover { background: rgba(255,255,255,0.08); }
  .furniture-item .icon { font-size: 20px; }
  .furniture-item .info { flex: 1; margin: 0 10px; text-align: right; }
  .furniture-item .name { font-weight: 500; }
  .furniture-item .size { font-size: 11px; color: #666; }
  .add-btn {
    background: rgba(99,102,241,0.3); border: none; color: #a5b4fc;
    width: 28px; height: 28px; border-radius: 6px; cursor: pointer; font-size: 16px;
    display: flex; align-items: center; justify-content: center;
  }
  .add-btn:hover { background: rgba(99,102,241,0.5); }
  .view-controls { display: flex; gap: 6px; flex-wrap: wrap; }
  .view-btn {
    padding: 6px 12px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1);
    border-radius: 6px; color: #aaa; font-size: 12px; cursor: pointer; transition: all 0.2s;
  }
  .view-btn:hover { background: rgba(255,255,255,0.12); color: #fff; }
  .save-controls { display: flex; gap: 6px; margin-top: 8px; }
  .save-btn {
    flex: 1; padding: 8px 12px; border-radius: 8px; border: none; cursor: pointer;
    font-size: 12px; font-weight: 600; transition: all 0.2s;
  }
  .save-btn.primary { background: rgba(34,197,94,0.3); color: #86efac; }
  .save-btn.primary:hover { background: rgba(34,197,94,0.5); }
  .save-btn.danger { background: rgba(239,68,68,0.2); color: #fca5a5; }
  .save-btn.danger:hover { background: rgba(239,68,68,0.4); }
  .save-status { font-size: 11px; color: #4ade80; text-align: center; margin-top: 6px; min-height: 16px; transition: opacity 0.3s; }
  #selected-info {
    position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%);
    background: rgba(20,20,40,0.95); backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.15); border-radius: 12px;
    padding: 12px 20px; z-index: 100; display: none; align-items: center; gap: 16px; font-size: 13px;
  }
  #selected-info.visible { display: flex; }
  #selected-info button { padding: 6px 14px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px; font-weight: 500; }
  .btn-rotate { background: rgba(99,102,241,0.3); color: #a5b4fc; }
  .btn-delete { background: rgba(239,68,68,0.3); color: #fca5a5; }
  .btn-rotate:hover { background: rgba(99,102,241,0.5); }
  .btn-delete:hover { background: rgba(239,68,68,0.5); }
  #instructions {
    position: fixed; top: 12px; left: 50%; transform: translateX(-50%);
    background: rgba(20,20,40,0.85); backdrop-filter: blur(8px);
    border: 1px solid rgba(255,255,255,0.1); border-radius: 10px;
    padding: 8px 18px; z-index: 90; font-size: 12px; color: #888; pointer-events: none; transition: opacity 0.5s;
  }
  #minimap { width: 100%; height: 220px; background: rgba(0,0,0,0.3); border-radius: 8px; border: 1px solid rgba(255,255,255,0.08); margin-bottom: 8px; }
</style>
</head>
<body>
<div id="canvas-container"></div>
<div id="panel">
  <div class="panel-section">
    <h1>Shapira Apartment</h1>
    <div class="subtitle">Interactive 3D Mockup</div>
    <canvas id="minimap"></canvas>
  </div>
  <div class="panel-section">
    <h2>Rooms</h2>
    <button class="room-btn active" data-room="living" onclick="selectRoom('living')">סלון + מטבח <span class="dims">4.5m x 5.1m</span></button>
    <button class="room-btn" data-room="bedroom" onclick="selectRoom('bedroom')">חדר שינה <span class="dims">3.3m x 4.8m</span></button>
    <button class="room-btn" data-room="toilet" onclick="selectRoom('toilet')">שירותים <span class="dims">~2.0m x 1.5m</span></button>
    <button class="room-btn" data-room="patio" onclick="selectRoom('patio')">פטיו <span class="dims">~2.3m x 1.5m</span></button>
  </div>
  <div class="panel-section">
    <h2>Wall Color</h2>
    <div class="color-grid" id="color-grid"></div>
    <div class="custom-color"><input type="color" id="custom-color" value="#ffffff"><label>Custom color</label></div>
  </div>
  <div class="panel-section">
    <h2>Furniture</h2>
    <div id="furniture-list"></div>
  </div>
  <div class="panel-section">
    <h2>View</h2>
    <div class="view-controls">
      <button class="view-btn" onclick="setView('perspective')">3D</button>
      <button class="view-btn" onclick="setView('top')">Top 2D</button>
      <button class="view-btn" onclick="setView('living')">Living</button>
      <button class="view-btn" onclick="setView('bedroom')">Bedroom</button>
      <button class="view-btn" onclick="setView('walkthrough')">Walkthrough</button>
    </div>
  </div>
  <div class="panel-section">
    <h2>Save / Load</h2>
    <div class="save-controls">
      <button class="save-btn primary" onclick="saveState()">Save</button>
      <button class="save-btn danger" onclick="resetState()">Reset</button>
    </div>
    <div class="save-status" id="save-status"></div>
  </div>
</div>
<button id="toggle-panel" onclick="togglePanel()">&#9664;</button>
<div id="instructions">Drag to rotate | Scroll to zoom | Right-click to pan | Click furniture to select & drag</div>
<div id="selected-info">
  <span id="selected-name"></span>
  <button class="btn-rotate" onclick="rotateSelected()">Rotate 90&deg;</button>
  <button class="btn-delete" onclick="deleteSelected()">Delete</button>
</div>

<script type="importmap">
{ "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/" } }
</script>
<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { SSAOPass } from 'three/addons/postprocessing/SSAOPass.js';
import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';

// ================================================================
// Z-AXIS FLIPPED: +Z = SOUTH (street/bedroom), low Z = NORTH (patio)
// This makes the 3D top-down view match the minimap exactly.
// ================================================================
const STORAGE_KEY = 'shapira-apt-state-v4';
const container = document.getElementById('canvas-container');
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87CEEB);
scene.fog = new THREE.Fog(0x87CEEB, 30, 60);

const camera = new THREE.PerspectiveCamera(55, window.innerWidth/window.innerHeight, 0.1, 100);
// Camera from NORTH (low z) looking SOUTH (high z): bedroom=bottom, patio=top
camera.position.set(3, 14, -4);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.2;
renderer.outputColorSpace = THREE.SRGBColorSpace;
container.appendChild(renderer.domElement);
const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true; controls.dampingFactor = 0.08;
controls.target.set(3, 0, 6);

// ============ ENVIRONMENT MAP (for realistic reflections) ============
const pmrem = new THREE.PMREMGenerator(renderer);
pmrem.compileEquirectangularShader();
// Generate a simple warm interior environment
const envScene = new THREE.Scene();
envScene.background = new THREE.Color(0xf5ece0);
const envL1 = new THREE.DirectionalLight(0xfff0d4, 1); envL1.position.set(1,1,1); envScene.add(envL1);
const envL2 = new THREE.HemisphereLight(0xfff8f0, 0xb0a080, 0.8); envScene.add(envL2);
// Fake walls as colored planes for environment reflections
const envWall = new THREE.MeshBasicMaterial({color: 0xf0ebe5, side: THREE.BackSide});
const envBox = new THREE.Mesh(new THREE.BoxGeometry(20,10,20), envWall);
envScene.add(envBox);
const envRT = pmrem.fromScene(envScene, 0.04);
scene.environment = envRT.texture;

// ============ POST-PROCESSING (SSAO for realism) ============
const composer = new EffectComposer(renderer);
composer.addPass(new RenderPass(scene, camera));
const ssaoPass = new SSAOPass(scene, camera, window.innerWidth, window.innerHeight);
ssaoPass.kernelRadius = 0.3;
ssaoPass.minDistance = 0.001;
ssaoPass.maxDistance = 0.15;
ssaoPass.output = SSAOPass.OUTPUT.Default;
composer.addPass(ssaoPass);
composer.addPass(new OutputPass());

// ============ LIGHTING ============
scene.add(new THREE.HemisphereLight(0xfff8f0, 0xb0a090, 0.6));
const sun = new THREE.DirectionalLight(0xfff0d4, 2.0);
sun.position.set(8, 12, 6); sun.castShadow = true;
sun.shadow.mapSize.set(2048, 2048);
sun.shadow.camera.left = -14; sun.shadow.camera.right = 14;
sun.shadow.camera.top = 14; sun.shadow.camera.bottom = -14;
sun.shadow.bias = -0.0005; sun.shadow.normalBias = 0.02;
scene.add(sun);
const fill=new THREE.DirectionalLight(0xd4e8ff,0.4);fill.position.set(-6,8,-4);scene.add(fill);

function addCeilingLight(x,z,intensity=0.8){
  const l=new THREE.PointLight(0xffe4b5,intensity,8); l.position.set(x,2.9,z);
  l.castShadow=true; l.shadow.mapSize.set(512,512); scene.add(l);
  const s=new THREE.Mesh(new THREE.CylinderGeometry(.12,.18,.1,16,1,true),
    new THREE.MeshStandardMaterial({color:0xfff8e7,roughness:0.4,side:THREE.DoubleSide,emissive:0xfff0c0,emissiveIntensity:0.3}));
  s.position.set(x,3.1,z); scene.add(s);
}

// ================================================================
// ROOM LAYOUT — Z FLIPPED (new_z = 11.4 - old_z)
// Patio/Toilet: z=0..1.5 (NORTH, top of screen)
// Living room:  z=1.5..6.6 (MIDDLE)
// Bedroom:      z=6.6..11.4 (SOUTH/street, bottom of screen)
// Balcony:      x=4.5..6.3, z=1.5..11.4 (east side)
// Building hallway: x=0..1.2, z=6.6..11.4 (west of bedroom)
// ================================================================
const MZ = 11.4; // max Z for minimap coordinate mapping
const WH = 3.2, WT = 0.15;
const LV = { x:0, z:1.5, w:4.5, d:5.1 };     // x=0..4.5, z=1.5..6.6
const BR = { x:1.2, z:6.6, w:3.3, d:4.8 };    // x=1.2..4.5, z=6.6..11.4
const PT = { x:0, z:0, w:2.3, d:1.5 };         // x=0..2.3, z=0..1.5
const TT = { x:2.5, z:0, w:2.0, d:1.5 };       // x=2.5..4.5, z=0..1.5
const BL = { x:4.5, z:1.5, w:1.8, d:9.9 };     // x=4.5..6.3, z=1.5..11.4

addCeilingLight(2.25, 4.4, 0.9);  // Living room
addCeilingLight(2.25, 2.6, 0.5);  // Kitchen area
addCeilingLight(2.85, 9.0, 0.7);  // Bedroom
addCeilingLight(1.15, 0.75, 0.3); // Patio
addCeilingLight(3.5, 0.75, 0.4);  // Toilet

// ============ MATERIALS ============
function createTileTexture(col1,grout,tilesX=15,tilesZ=17){
  const cv=document.createElement('canvas'); cv.width=512; cv.height=512;
  const ctx=cv.getContext('2d'); const tw=cv.width/tilesX, th=cv.height/tilesZ;
  ctx.fillStyle=grout; ctx.fillRect(0,0,512,512);
  const c1=parseInt(col1.slice(1),16);
  for(let i=0;i<tilesX;i++) for(let j=0;j<tilesZ;j++){
    const v=Math.random()*15-7;
    const r=Math.min(255,Math.max(0,((c1>>16)&0xff)+v));
    const g=Math.min(255,Math.max(0,((c1>>8)&0xff)+v));
    const b=Math.min(255,Math.max(0,(c1&0xff)+v));
    ctx.fillStyle=`rgb(${r},${g},${b})`; ctx.fillRect(i*tw+1,j*th+1,tw-2,th-2);
  }
  const t=new THREE.CanvasTexture(cv); t.wrapS=t.wrapT=THREE.RepeatWrapping; return t;
}
const lvFloorMat=new THREE.MeshStandardMaterial({map:createTileTexture('#d4c5a9','#a09080',15,17),roughness:0.3,metalness:0.05,envMapIntensity:0.4});
const brFloorMat=new THREE.MeshStandardMaterial({map:createTileTexture('#d0c0a5','#9a8a75',11,16),roughness:0.3,metalness:0.05,envMapIntensity:0.4});
const wetFloorMat=new THREE.MeshStandardMaterial({map:createTileTexture('#d8d8d0','#999999',8,5),roughness:0.15,metalness:0.1,envMapIntensity:0.6});
const balFloorMat=new THREE.MeshStandardMaterial({map:createTileTexture('#b8a888','#807060',6,33),roughness:0.6,envMapIntensity:0.2});
const ceilingMat=new THREE.MeshStandardMaterial({color:0xffffff,roughness:0.9,envMapIntensity:0.1});

const wallColors={living:'#f5f0eb',bedroom:'#f5f0eb',toilet:'#e8e8e8',patio:'#f0ede8'};
const wallMats={};
function mkWM(r){wallMats[r]=new THREE.MeshStandardMaterial({color:wallColors[r],roughness:0.85,metalness:0.0,side:THREE.DoubleSide,envMapIntensity:0.3})}
Object.keys(wallColors).forEach(mkWM);
const doorMat=new THREE.MeshStandardMaterial({color:0x6B4226,roughness:0.45,metalness:0.0,envMapIntensity:0.5});
const glassMat=new THREE.MeshPhysicalMaterial({color:0xc8e8ff,transparent:true,opacity:0.12,roughness:0.0,metalness:0.0,transmission:0.9,thickness:0.05,ior:1.5,envMapIntensity:1.0});

// ============ BUILDERS ============
function wall(x,y,z,w,h,d,room){
  const m=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),wallMats[room]);
  m.position.set(x,y,z);m.castShadow=true;m.receiveShadow=true;m.userData={room,isWall:true};scene.add(m);return m;
}
function mkFloor(rx,rz,rw,rd,mat){
  const m=new THREE.Mesh(new THREE.PlaneGeometry(rw,rd),mat);
  m.rotation.x=-Math.PI/2;m.position.set(rx+rw/2,0,rz+rd/2);m.receiveShadow=true;scene.add(m);
}
function mkCeiling(rx,rz,rw,rd){
  const m=new THREE.Mesh(new THREE.PlaneGeometry(rw,rd),ceilingMat);
  m.rotation.x=Math.PI/2;m.position.set(rx+rw/2,WH,rz+rd/2);scene.add(m);
}
function at(m,x,y,z){m.position.set(x,y,z);return m;}
function mkWindow(x,y,z,w,h,rotY=0){
  const g=new THREE.Group(),ft=0.04,wf=new THREE.MeshStandardMaterial({color:0xe0dcd5,roughness:0.3,metalness:0.1});
  g.add(at(new THREE.Mesh(new THREE.BoxGeometry(w,ft,ft),wf),0,h/2,0));
  g.add(at(new THREE.Mesh(new THREE.BoxGeometry(w,ft,ft),wf),0,-h/2,0));
  g.add(at(new THREE.Mesh(new THREE.BoxGeometry(ft,h,ft),wf),-w/2,0,0));
  g.add(at(new THREE.Mesh(new THREE.BoxGeometry(ft,h,ft),wf),w/2,0,0));
  g.add(at(new THREE.Mesh(new THREE.BoxGeometry(ft,h,ft),wf),0,0,0));
  g.add(at(new THREE.Mesh(new THREE.PlaneGeometry(w/2-ft,h-ft),glassMat),-w/4,0,0));
  g.add(at(new THREE.Mesh(new THREE.PlaneGeometry(w/2-ft,h-ft),glassMat),w/4,0,0));
  g.position.set(x,y,z);g.rotation.y=rotY;scene.add(g);
}
function mkDoor(x,y,z,w,h,rotY=0){
  const g=new THREE.Group();
  g.add(at(new THREE.Mesh(new THREE.BoxGeometry(w,h,0.05),doorMat),0,h/2,0));
  const hnd=new THREE.Mesh(new THREE.CylinderGeometry(.018,.018,.12,8),new THREE.MeshStandardMaterial({color:0xc0c0c0,metalness:0.9,roughness:0.15}));
  hnd.rotation.x=Math.PI/2;hnd.position.set(w/2-.1,h*.45,.04);g.add(hnd);
  g.position.set(x,y,z);g.rotation.y=rotY;scene.add(g);
}

// ============ FLOORS + CEILINGS ============
mkFloor(LV.x,LV.z,LV.w,LV.d,lvFloorMat);
mkFloor(BR.x,BR.z,BR.w,BR.d,brFloorMat);
mkFloor(PT.x,PT.z,PT.w,PT.d,wetFloorMat);
mkFloor(TT.x,TT.z,TT.w,TT.d,wetFloorMat);
mkFloor(BL.x,BL.z,BL.w,BL.d,balFloorMat);
mkCeiling(LV.x,LV.z,LV.w,LV.d);
mkCeiling(BR.x,BR.z,BR.w,BR.d);
mkCeiling(PT.x,PT.z,PT.w,PT.d);
mkCeiling(TT.x,TT.z,TT.w,TT.d);
// Ground
const gnd=new THREE.Mesh(new THREE.PlaneGeometry(40,40),new THREE.MeshStandardMaterial({color:0x8a9a6a,roughness:0.9}));
gnd.rotation.x=-Math.PI/2;gnd.position.set(3,-0.02,5);gnd.receiveShadow=true;scene.add(gnd);

// ============ LIVING ROOM WALLS (x=0..4.5, z=1.5..6.6) ============
// West wall (x=0) — main door at z≈5.15
wall(0,WH/2,6.2, WT,WH,0.8, 'living');       // z=5.8..6.6
wall(0,2.75,5.15, WT,0.9,0.9, 'living');      // above door
wall(0,WH/2,2.9, WT,WH,3.2, 'living');        // z=1.3..4.5
mkDoor(0,0,5.15, 0.9,2.1, Math.PI/2);

// North wall (z=1.5) — kitchen wall, patio door at x≈1.45
wall(0.55,WH/2,1.5, 1.1,WH,WT, 'living');
wall(1.45,2.75,1.5, 0.7,0.9,WT, 'living');
wall(3.1,WH/2,1.5, 2.7,WH,WT, 'living');
mkDoor(1.45,0,1.5, 0.7,2.1, Math.PI);

// East wall (x=4.5) — balcony window at z≈3.8
wall(4.5,WH/2,5.6, WT,WH,2.0, 'living');
wall(4.5,0.4,3.8, WT,0.8,1.2, 'living');
wall(4.5,2.75,3.8, WT,0.9,1.2, 'living');
wall(4.5,WH/2,2.4, WT,WH,1.8, 'living');
mkWindow(4.5,1.55,3.8, 1.1,1.5, Math.PI/2);

// South/Dividing wall (z=6.6) — bedroom door at east end
wall(0.6,WH/2,6.6, 1.2,WH,WT, 'living');     // x=0..1.2
wall(2.35,WH/2,6.6, 2.3,WH,WT, 'living');    // x=1.2..3.5 (TV wall)
wall(4.0,2.75,6.6, 0.8,0.9,WT, 'living');     // above bedroom door
wall(4.45,WH/2,6.6, 0.1,WH,WT, 'living');
mkDoor(4.0,0,6.6, 0.8,2.1, Math.PI);

// ============ BEDROOM WALLS (x=1.2..4.5, z=6.6..11.4) ============
wall(1.2,WH/2,9.0, WT,WH,4.8, 'bedroom');    // West (x=1.2)

// South wall (z=11.4) — street windows
wall(1.55,WH/2,11.4, 0.7,WH,WT, 'bedroom');
wall(2.35,0.4,11.4, 0.7,0.8,WT, 'bedroom');
wall(2.35,2.75,11.4, 0.7,0.9,WT, 'bedroom');
mkWindow(2.35,1.55,11.4, 0.7,1.5, Math.PI);
wall(2.95,WH/2,11.4, 0.5,WH,WT, 'bedroom');
wall(3.6,0.4,11.4, 0.7,0.8,WT, 'bedroom');
wall(3.6,2.75,11.4, 0.7,0.9,WT, 'bedroom');
mkWindow(3.6,1.55,11.4, 0.7,1.5, Math.PI);
wall(4.25,WH/2,11.4, 0.5,WH,WT, 'bedroom');

wall(4.5,WH/2,9.0, WT,WH,4.8, 'bedroom');    // East (x=4.5)

// ============ PATIO (x=0..2.3, z=0..1.5) ============
wall(1.15,WH/2,0, 2.3,WH,WT, 'patio');        // North wall (z=0)
wall(0,WH/2,0.75, WT,WH,1.5, 'patio');         // West
wall(2.3,WH/2,1.35, WT,WH,0.3, 'patio');
wall(2.3,2.75,0.75, WT,0.9,0.7, 'patio');
wall(2.3,WH/2,0.15, WT,WH,0.3, 'patio');
mkDoor(2.3,0,0.75, 0.7,2.1, -Math.PI/2);      // Patio→Toilet

// ============ TOILET (x=2.5..4.5, z=0..1.5) ============
wall(3.5,WH/2,0, 2.0,WH,WT, 'toilet');
wall(4.5,WH/2,0.75, WT,WH,1.5, 'toilet');
wall(3.5,WH/2,1.5, 2.0,WH,WT, 'toilet');      // South (shared with living)
const tMat=new THREE.MeshStandardMaterial({color:0xf0f0f0,roughness:0.15,metalness:0.05});
scene.add(at(new THREE.Mesh(new THREE.BoxGeometry(.4,.4,.55),tMat),3.5,.2,0.5));
scene.add(at(new THREE.Mesh(new THREE.BoxGeometry(.35,.7,.15),tMat),3.5,.7,0.2));
scene.add(at(new THREE.Mesh(new THREE.BoxGeometry(.45,.1,.35),tMat),4.2,.85,1.0));
mkWindow(3.5,2.3,0, 0.5,0.4, Math.PI);

// ============ BALCONY (x=4.5..6.3, z=1.5..11.4) ============
const railMat=new THREE.MeshStandardMaterial({color:0x2a6b3a,roughness:0.4,metalness:0.4});
const rH=1.1;
scene.add(at(new THREE.Mesh(new THREE.BoxGeometry(.04,rH,BL.d),railMat),BL.x+BL.w,rH/2,BL.z+BL.d/2));
scene.add(at(new THREE.Mesh(new THREE.BoxGeometry(BL.w,rH,.04),railMat),BL.x+BL.w/2,rH/2,BL.z));
scene.add(at(new THREE.Mesh(new THREE.BoxGeometry(BL.w,rH,.04),railMat),BL.x+BL.w/2,rH/2,BL.z+BL.d));
for(let i=0;i<=20;i++)
  scene.add(at(new THREE.Mesh(new THREE.CylinderGeometry(.01,.01,rH,6),railMat),BL.x+BL.w,rH/2,BL.z+i*BL.d/20));

// ============ FURNITURE CATALOG ============
const furnitureInScene=[]; let selectedFurniture=null;
const raycaster=new THREE.Raycaster(),mouse=new THREE.Vector2();
const FURNITURE_CATALOG=[
  {id:'brown_sofa',name:'Tufted Sofa',nameHe:'ספה חומה',w:2.2,h:0.8,d:0.9,color:0xC8A872,icon:'&#x1F6CB;'},
  {id:'lack_table',name:'LACK Table',nameHe:'שולחן LACK',w:0.55,h:0.45,d:0.55,color:0xf5f5f0,icon:'&#9749;'},
  {id:'lack_bench',name:'LACK Bench',nameHe:'ספסל LACK',w:0.9,h:0.45,d:0.55,color:0xf5f5f0,icon:'&#9749;'},
  {id:'tv50',name:'50" TV + Stand',nameHe:'טלוויזיה 50"',w:1.15,h:0.5,d:0.4,color:0x222222,icon:'&#x1F4FA;'},
  {id:'rattan_cab',name:'Rattan Cabinet',nameHe:'ארון קש',w:0.8,h:1.6,d:0.4,color:0xC4A862,icon:'&#x1F6AA;'},
  {id:'ivar',name:'IVAR Shelf',nameHe:'כוננית IVAR',w:0.8,h:1.8,d:0.3,color:0xDEB887,icon:'&#x1F4DA;'},
  {id:'work_desk',name:'Work Desk',nameHe:'שולחן עבודה',w:1.8,h:0.75,d:0.55,color:0x5C4033,icon:'&#x1F5A5;'},
  {id:'monitor',name:'Monitor',nameHe:'מסך',w:0.6,h:0.4,d:0.05,color:0x111111,icon:'&#x1F5A5;'},
  {id:'office_chair',name:'Office Chair',nameHe:'כיסא משרדי',w:0.5,h:1.0,d:0.5,color:0x333333,icon:'&#x1FA91;'},
  {id:'jute_rug',name:'Jute Rug',nameHe:'שטיח יוטה',w:2.3,h:0.02,d:1.6,color:0xC4A862,icon:'&#x1F7EB;'},
  {id:'pouf',name:'Rattan Pouf',nameHe:'פוף קש',w:0.35,h:0.35,d:0.35,color:0xC4A862,icon:'&#x1FA91;'},
  {id:'plant',name:'Plant',nameHe:'צמח',w:0.35,h:1.0,d:0.35,color:0x228B22,icon:'&#x1F33F;'},
  {id:'bed_double',name:'Double Bed',nameHe:'מיטה זוגית',w:1.6,h:0.5,d:2.0,color:0xDEB887,icon:'&#x1F6CF;'},
  {id:'wardrobe',name:'Wardrobe',nameHe:'ארון בגדים',w:1.5,h:2.0,d:0.6,color:0xC4A870,icon:'&#x1F6AA;'},
  {id:'nightstand',name:'Nightstand',nameHe:'שידה',w:0.45,h:0.5,d:0.4,color:0xf0f0f0,icon:'&#x1F6CF;'},
  {id:'chair',name:'Chair',nameHe:'כיסא',w:0.45,h:0.85,d:0.45,color:0x5C4033,icon:'&#x1FA91;'},
  {id:'fridge',name:'Refrigerator',nameHe:'מקרר',w:0.65,h:1.7,d:0.65,color:0xb0b0b0,icon:'&#x1F9CA;'},
  {id:'counter_stove',name:'Counter+Stove',nameHe:'משטח+כיריים',w:2.4,h:0.88,d:0.6,color:0xe8ddd0,icon:'&#x1F373;'},
  {id:'upper_cabinets',name:'Upper Cabinets',nameHe:'ארונות עליונים',w:2.0,h:0.55,d:0.35,color:0x8B6914,icon:'&#x1F4E6;'},
  {id:'kitchen_island',name:'Kitchen Island',nameHe:'אי מטבח',w:2.0,h:0.88,d:0.55,color:0xe8ddd0,icon:'&#x1F372;'},
  {id:'washing_machine',name:'Washing Machine',nameHe:'מכונת כביסה',w:0.6,h:0.85,d:0.6,color:0xeeeeee,icon:'&#x1F9FA;'},
];

function createFurnitureMesh(item){
  const g=new THREE.Group();
  const mat=(c,r=0.65,m=0.0)=>new THREE.MeshStandardMaterial({color:c,roughness:r,metalness:m,envMapIntensity:m>0.3?0.8:0.3});
  function m(geo,material,x,y,z){const mesh=new THREE.Mesh(geo,material);mesh.position.set(x,y,z);return mesh;}
  if(item.id==='brown_sofa'){
    const fabric=mat(0xC8A872,0.88),fabricDk=mat(0xB89862,0.9);
    g.add(m(new THREE.BoxGeometry(item.w,.15,item.d),mat(0x8B7355,0.7),0,.15,0));
    g.add(m(new THREE.BoxGeometry(item.w-.12,.12,item.d-.14),fabric,0,.28,.03));
    for(let bx=-1;bx<=1;bx++)for(let bz=0;bz<=1;bz++)
      g.add(m(new THREE.SphereGeometry(.025,6,6),fabricDk,bx*.32,.33,bz*.2-.05));
    g.add(m(new THREE.BoxGeometry(item.w-.12,.42,.12),fabric,0,.52,-item.d/2+.08));
    for(let bx=-2;bx<=2;bx++)for(let by=0;by<=1;by++)
      g.add(m(new THREE.SphereGeometry(.018,6,6),fabricDk,bx*.22,.4+by*.18,-item.d/2+.02));
    for(const s of[-1,1]){const b=new THREE.Mesh(new THREE.CylinderGeometry(.08,.08,item.d-.05,12),fabric);
      b.rotation.x=Math.PI/2;b.position.set(s*(item.w/2-.06),.38,.02);g.add(b);}
    const pM=mat(0x8B2020,0.85),pM2=mat(0xDDCC88,0.85);
    for(const px of[-.55,.55]){const pg=new THREE.Group();
      pg.add(m(new THREE.BoxGeometry(.3,.3,.08),pM,0,0,0));
      pg.add(m(new THREE.BoxGeometry(.12,.12,.005),pM2,0,0,.042));
      pg.rotation.z=0.15*(px>0?-1:1);pg.position.set(px,.52,-item.d/2+.15);g.add(pg);}
    for(const dx of[-1,1])for(const dz of[-1,1])
      g.add(m(new THREE.CylinderGeometry(.018,.015,.07,8),mat(0x4a3520,0.5),dx*(item.w/2-.1),.035,dz*(item.d/2-.08)));
  }else if(item.id==='tv50'){
    g.add(m(new THREE.BoxGeometry(1.2,.42,.4),mat(0xf0f0f0,0.4),0,.21,0));
    g.add(m(new THREE.BoxGeometry(1.16,.02,.36),mat(0xe0e0e0,0.4),0,.21,0));
    g.add(m(new THREE.BoxGeometry(1.1,.62,.035),mat(0x1a1a1a,0.15,0.1),0,.74,0));
    g.add(m(new THREE.BoxGeometry(1.06,.58,.005),mat(0x111122,0.08,0.15),0,.74,.02));
  }else if(item.id==='rattan_cab'){
    g.add(m(new THREE.BoxGeometry(item.w,item.h,item.d),mat(0xB8953E,0.7),0,item.h/2,0));
    g.add(m(new THREE.BoxGeometry(item.w*.42,item.h*.85,.015),mat(0xD4AF60,0.85),-item.w*.24,item.h/2,item.d/2+.005));
    g.add(m(new THREE.BoxGeometry(item.w*.42,item.h*.85,.015),mat(0xD4AF60,0.85),item.w*.24,item.h/2,item.d/2+.005));
  }else if(item.id==='ivar'){
    for(const s of[-1,1])g.add(m(new THREE.BoxGeometry(.03,item.h,item.d),mat(item.color,0.6),s*(item.w/2-.015),item.h/2,0));
    for(let i=0;i<6;i++)g.add(m(new THREE.BoxGeometry(item.w,.018,item.d),mat(item.color,0.6),0,.05+i*item.h/5,0));
  }else if(item.id==='work_desk'){
    g.add(m(new THREE.BoxGeometry(item.w,.025,item.d),mat(item.color,0.45),0,item.h,0));
    for(const dx of[-1,1])for(const dz of[-1,1])
      g.add(m(new THREE.CylinderGeometry(.02,.02,item.h,8),mat(0x444444,0.2,0.6),dx*(item.w/2-.04),item.h/2,dz*(item.d/2-.04)));
  }else if(item.id==='monitor'){
    g.add(m(new THREE.BoxGeometry(item.w,item.h,.02),mat(0x1a1a1a,0.12,0.1),0,item.h/2+.75,0));
    g.add(m(new THREE.BoxGeometry(.15,.06,.12),mat(0x333333,0.3,0.4),0,.78,0));
    g.add(m(new THREE.CylinderGeometry(.012,.012,.28,8),mat(0x333333,0.3,0.4),0,.9,0));
  }else if(item.id==='office_chair'){
    g.add(m(new THREE.BoxGeometry(.44,.06,.44),mat(0x2a2a2a,0.8),0,.45,0));
    g.add(m(new THREE.BoxGeometry(.42,.42,.035),mat(0x2a2a2a,0.8),0,.68,-.22));
    g.add(m(new THREE.CylinderGeometry(.022,.022,.38,8),mat(0x666666,0.2,0.7),0,.24,0));
  }else if(item.id==='jute_rug'){
    const rug=new THREE.Mesh(new THREE.PlaneGeometry(item.w,item.d),mat(0xC4A862,0.95));
    rug.rotation.x=-Math.PI/2;rug.position.y=.005;rug.receiveShadow=true;g.add(rug);
  }else if(item.id==='pouf'){
    g.add(m(new THREE.CylinderGeometry(.17,.15,.35,16),mat(0xC4A862,0.85),0,.175,0));
  }else if(item.id==='plant'){
    g.add(m(new THREE.CylinderGeometry(.1,.075,.22,12),mat(0xC27030,0.8),0,.11,0));
    g.add(m(new THREE.SphereGeometry(.16,8,8),mat(0x2a7a2a,0.85),0,.5,0));
    g.add(m(new THREE.SphereGeometry(.12,8,8),mat(0x2a7a2a,0.85),.08,.6,.05));
  }else if(item.id==='bed_double'){
    const fr=mat(0xC8AD7A,0.55),wh=mat(0xf8f4ee,0.9);
    g.add(m(new THREE.BoxGeometry(item.w+.06,.18,item.d+.06),fr,0,.09,0));
    g.add(m(new THREE.BoxGeometry(item.w,.2,item.d),wh,0,.33,0));
    g.add(m(new THREE.BoxGeometry(item.w-.05,.06,item.d-.2),mat(0xffffff,0.85),0,.46,.1));
    g.add(m(new THREE.BoxGeometry(.55,.1,.35),mat(0xffffff,0.9),-.35,.48,-item.d/2+.22));
    g.add(m(new THREE.BoxGeometry(.55,.1,.35),mat(0xffffff,0.9),.35,.48,-item.d/2+.22));
    g.add(m(new THREE.BoxGeometry(item.w,.7,.04),fr,0,.6,-item.d/2));
    g.add(m(new THREE.BoxGeometry(item.w-.1,.04,item.d*.55),mat(0xCC5533,0.85),0,.48,.25));
  }else if(item.id==='lack_table'||item.id==='lack_bench'){
    const top=mat(0xf5f5f0,0.35);
    g.add(m(new THREE.BoxGeometry(item.w,.025,item.d),top,0,item.h,0));
    for(const dx of[-1,1])for(const dz of[-1,1])
      g.add(m(new THREE.BoxGeometry(.035,item.h,.035),top,dx*(item.w/2-.025),item.h/2,dz*(item.d/2-.025)));
  }else if(item.id==='wardrobe'){
    g.add(m(new THREE.BoxGeometry(item.w,item.h,item.d),mat(0xB8A070,0.6),0,item.h/2,0));
  }else if(item.id==='nightstand'){
    g.add(m(new THREE.BoxGeometry(item.w,item.h,item.d),mat(0xf0f0f0,0.4),0,item.h/2,0));
  }else if(item.id==='fridge'){
    g.add(m(new THREE.BoxGeometry(item.w,item.h,item.d),mat(0xd0d0d0,0.2,0.5),0,item.h/2,0));
    g.add(m(new THREE.BoxGeometry(.02,.25,.03),mat(0xcccccc,0.15,0.8),item.w/2-.06,item.h*.75,item.d/2+.02));
  }else if(item.id==='counter_stove'){
    g.add(m(new THREE.BoxGeometry(item.w,.82,item.d),mat(0xe0d5c5,0.55),0,.41,0));
    g.add(m(new THREE.BoxGeometry(item.w+.02,.04,item.d+.02),mat(0xd4c8b0,0.3,0.05),0,.86,0));
    for(const bx of[-.3,.3])for(const bz of[-.1,.1])
      g.add(m(new THREE.CylinderGeometry(.07,.07,.015,16),mat(0x2a2a2a,0.3,0.5),bx,.9,bz));
  }else if(item.id==='upper_cabinets'){
    g.add(m(new THREE.BoxGeometry(item.w,item.h,item.d),mat(0x8B6914,0.5),0,item.h/2,0));
  }else if(item.id==='kitchen_island'){
    g.add(m(new THREE.BoxGeometry(item.w,.82,item.d),mat(0xe0d5c5,0.55),0,.41,0));
    g.add(m(new THREE.BoxGeometry(item.w+.02,.04,item.d+.02),mat(0xd4c8b0,0.3,0.05),0,.86,0));
  }else if(item.id==='washing_machine'){
    g.add(m(new THREE.BoxGeometry(item.w,item.h,item.d),mat(0xeeeeee,0.2,0.3),0,item.h/2,0));
    g.add(m(new THREE.CylinderGeometry(.18,.18,.02,20),mat(0xcccccc,0.1,0.5),0,item.h*.45,item.d/2+.01));
  }else{
    g.add(m(new THREE.BoxGeometry(item.w,item.h,item.d),mat(item.color),0,item.h/2,0));
  }
  g.traverse(c=>{if(c.isMesh){c.castShadow=true;c.receiveShadow=true;}});
  g.userData={...item,isFurniture:true};
  return g;
}

function placeFurniture(id,x,z,rotY=0){
  const item=FURNITURE_CATALOG.find(f=>f.id===id);if(!item)return null;
  const mesh=createFurnitureMesh(item);
  mesh.position.set(x,0,z);mesh.rotation.y=rotY;
  scene.add(mesh);furnitureInScene.push(mesh);return mesh;
}

// ============ DEFAULT PLACEMENTS (Z-flipped) ============
function placeDefaults(){
  // Living room furniture
  placeFurniture('brown_sofa', 2.25, 3.9);
  placeFurniture('jute_rug', 2.0, 5.2);
  placeFurniture('lack_table', 1.5, 5.2);
  placeFurniture('lack_bench', 2.6, 5.2);
  placeFurniture('pouf', 0.8, 4.9);
  placeFurniture('tv50', 2.5, 6.3, 0);         // TV on dividing wall, facing north (toward sofa)
  placeFurniture('rattan_cab', 1.5, 6.3, 0);
  placeFurniture('work_desk', 0.6, 2.9, -Math.PI/2);
  placeFurniture('monitor', 0.5, 2.9, -Math.PI/2);
  placeFurniture('office_chair', 1.4, 2.9, Math.PI/2);
  placeFurniture('ivar', 4.1, 5.4, Math.PI/2);
  placeFurniture('ivar', 4.1, 4.6, Math.PI/2);
  placeFurniture('plant', 4.2, 2.6);
  placeFurniture('plant', 0.3, 1.9);
  // Kitchen
  placeFurniture('fridge', 0.55, 1.85);
  placeFurniture('counter_stove', 3.0, 1.8);
  placeFurniture('upper_cabinets', 3.0, 1.65);
  placeFurniture('kitchen_island', 2.25, 3.1);
  // Bedroom
  placeFurniture('bed_double', 2.85, 7.7, 0);  // headboard against dividing wall (z≈6.7)
  placeFurniture('nightstand', 1.8, 7.2);
  placeFurniture('nightstand', 3.9, 7.2);
  placeFurniture('wardrobe', 1.6, 10.9);
  // Patio
  placeFurniture('washing_machine', 0.5, 1.05);
}

// Upper cabinets special Y
function fixUpperCabinets(){
  furnitureInScene.forEach(f=>{if(f.userData.id==='upper_cabinets')f.position.y=1.5;});
}

// ============ SAVE / LOAD ============
function getState(){
  return{items:furnitureInScene.map(f=>({id:f.userData.id,x:f.position.x,z:f.position.z,rotY:f.rotation.y})),
    wallColors:{...wallColors},version:4};
}
function loadState(state){
  furnitureInScene.forEach(f=>scene.remove(f));furnitureInScene.length=0;
  state.items.forEach(s=>placeFurniture(s.id,s.x,s.z,s.rotY));
  if(state.wallColors)Object.keys(state.wallColors).forEach(r=>{
    wallColors[r]=state.wallColors[r];if(wallMats[r])wallMats[r].color.set(state.wallColors[r]);
  });
  fixUpperCabinets();
}
function autoSave(){try{localStorage.setItem(STORAGE_KEY,JSON.stringify(getState()))}catch(e){}}
window.saveState=()=>{autoSave();const el=document.getElementById('save-status');el.textContent='Saved!';el.style.opacity='1';setTimeout(()=>el.style.opacity='0',2000)};
window.resetState=()=>{if(!confirm('Reset all furniture to default positions?'))return;
  localStorage.removeItem(STORAGE_KEY);furnitureInScene.forEach(f=>scene.remove(f));furnitureInScene.length=0;
  wallColors.living='#f5f0eb';wallColors.bedroom='#f5f0eb';wallColors.toilet='#e8e8e8';wallColors.patio='#f0ede8';
  Object.keys(wallColors).forEach(r=>wallMats[r].color.set(wallColors[r]));
  placeDefaults();fixUpperCabinets();selectFurnitureItem(null);
  const el=document.getElementById('save-status');el.textContent='Reset';el.style.opacity='1';setTimeout(()=>el.style.opacity='0',2000);
};
const saved=localStorage.getItem(STORAGE_KEY);
if(saved){try{const s=JSON.parse(saved);if(s.version>=4)loadState(s);else placeDefaults();}catch(e){placeDefaults();}}
else placeDefaults();
fixUpperCabinets();

// ============ INTERACTION ============
let isDragging=false;
const dragPlane=new THREE.Plane(new THREE.Vector3(0,1,0),0),dragOffset=new THREE.Vector3();
function selectFurnitureItem(mesh){
  if(selectedFurniture)selectedFurniture.traverse(c=>{if(c.isMesh&&c.material&&c.material.emissive)c.material.emissive.setHex(0)});
  selectedFurniture=mesh;
  if(mesh){mesh.traverse(c=>{if(c.isMesh&&c.material&&c.material.emissive)c.material.emissive.setHex(0x1a1a44)});
    document.getElementById('selected-name').textContent=mesh.userData.nameHe||mesh.userData.name;
    document.getElementById('selected-info').classList.add('visible');
  }else document.getElementById('selected-info').classList.remove('visible');
}
window.rotateSelected=()=>{if(selectedFurniture){selectedFurniture.rotation.y+=Math.PI/2;autoSave();}};
window.deleteSelected=()=>{if(!selectedFurniture)return;scene.remove(selectedFurniture);
  furnitureInScene.splice(furnitureInScene.indexOf(selectedFurniture),1);
  selectedFurniture=null;document.getElementById('selected-info').classList.remove('visible');autoSave();};
renderer.domElement.addEventListener('pointerdown',e=>{
  if(e.button!==0)return;
  mouse.x=(e.clientX/window.innerWidth)*2-1;mouse.y=-(e.clientY/window.innerHeight)*2+1;
  raycaster.setFromCamera(mouse,camera);
  const all=[];furnitureInScene.forEach(g=>g.traverse(c=>{if(c.isMesh){c.userData._pg=g;all.push(c)}}));
  const h=raycaster.intersectObjects(all,false);
  if(h.length>0&&h[0].object.userData._pg){
    selectFurnitureItem(h[0].object.userData._pg);isDragging=true;controls.enabled=false;
    const ip=new THREE.Vector3();raycaster.ray.intersectPlane(dragPlane,ip);
    dragOffset.subVectors(h[0].object.userData._pg.position,ip);return;}
  selectFurnitureItem(null);
});
renderer.domElement.addEventListener('pointermove',e=>{
  if(!isDragging||!selectedFurniture)return;
  mouse.x=(e.clientX/window.innerWidth)*2-1;mouse.y=-(e.clientY/window.innerHeight)*2+1;
  raycaster.setFromCamera(mouse,camera);const ip=new THREE.Vector3();raycaster.ray.intersectPlane(dragPlane,ip);
  selectedFurniture.position.x=ip.x+dragOffset.x;selectedFurniture.position.z=ip.z+dragOffset.z;
});
renderer.domElement.addEventListener('pointerup',()=>{if(isDragging)autoSave();isDragging=false;controls.enabled=true});

// ============ COLORS ============
let currentRoom='living';
const PALETTE=['#FFFFFF','#F5F0EB','#FFF8E7','#FFEEDD','#FFE4C4','#FFDAB9',
'#E8E4D9','#D4C5A9','#C8B898','#B8A88A','#A89070','#8B7D6B',
'#E0EBE0','#C8DBC8','#A8C8A8','#8FBC8F','#6B8E6B','#4A6741',
'#E0E8F0','#C8D8E8','#A8C0D8','#8BB0CC','#6B96B4','#4A7A9B',
'#F0E0E8','#E8C8D8','#D8A8C0','#CC8BAA','#B46B92','#943A6B',
'#F5F5DC','#FFE4B5','#DEB887','#D2B48C','#BC8F8F','#A0522D'];
const cg=document.getElementById('color-grid');
PALETTE.forEach(c=>{const s=document.createElement('div');s.className='color-swatch';s.style.backgroundColor=c;s.onclick=()=>setWallColor(c);cg.appendChild(s)});
document.getElementById('custom-color').addEventListener('input',e=>setWallColor(e.target.value));
function setWallColor(c){wallColors[currentRoom]=c;wallMats[currentRoom].color.set(c);autoSave();
  document.querySelectorAll('.color-swatch').forEach(s=>s.classList.toggle('active',rgbHex(s.style.backgroundColor)===c.toUpperCase()))}
function rgbHex(r){if(r.startsWith('#'))return r.toUpperCase();const m=r.match(/\d+/g);if(!m)return'';return'#'+m.slice(0,3).map(n=>parseInt(n).toString(16).padStart(2,'0')).join('').toUpperCase()}
window.selectRoom=r=>{currentRoom=r;document.querySelectorAll('.room-btn').forEach(b=>b.classList.toggle('active',b.dataset.room===r))};
function addFurniture(id){const item=FURNITURE_CATALOG.find(f=>f.id===id);if(!item)return;
  const mesh=createFurnitureMesh(item);let cx=2.25,cz=4;
  if(currentRoom==='bedroom'){cx=2.85;cz=9;}
  mesh.position.set(cx,0,cz);if(id==='upper_cabinets')mesh.position.y=1.5;
  scene.add(mesh);furnitureInScene.push(mesh);selectFurnitureItem(mesh);autoSave();}
window.addFurniture=addFurniture;
const fl=document.getElementById('furniture-list');
FURNITURE_CATALOG.forEach(item=>{const el=document.createElement('div');el.className='furniture-item';
  el.innerHTML=`<span class="icon">${item.icon}</span><div class="info"><div class="name">${item.nameHe}</div><div class="size">${item.w}m x ${item.d}m</div></div><button class="add-btn" onclick="addFurniture('${item.id}')">+</button>`;
  fl.appendChild(el)});

// ============ CAMERA VIEWS ============
function animCam(pos,tgt){const sp={...camera.position},st={...controls.target},dur=1000,t0=performance.now();
  function u(t){const p=Math.min((t-t0)/dur,1),e=p<.5?4*p*p*p:1-Math.pow(-2*p+2,3)/2;
    camera.position.set(sp.x+(pos.x-sp.x)*e,sp.y+(pos.y-sp.y)*e,sp.z+(pos.z-sp.z)*e);
    controls.target.set(st.x+(tgt.x-st.x)*e,st.y+(tgt.y-st.y)*e,st.z+(tgt.z-st.z)*e);
    if(p<1)requestAnimationFrame(u)}requestAnimationFrame(u)}
window.setView=v=>{switch(v){
  case'perspective':animCam({x:3,y:14,z:-4},{x:3,y:0,z:6});break;
  case'top':animCam({x:3,y:16,z:-2},{x:3,y:0,z:6});break;
  case'living':animCam({x:2.25,y:1.6,z:5.9},{x:2.25,y:1.5,z:3});break;
  case'bedroom':animCam({x:2.85,y:1.6,z:6.9},{x:2.85,y:1,z:9.4});break;
  case'walkthrough':
    const w=[{p:{x:.8,y:1.6,z:5.15},l:{x:2.2,y:1.5,z:2.9}},{p:{x:2.2,y:1.6,z:3.4},l:{x:2.2,y:1,z:1.9}},
      {p:{x:2.2,y:1.6,z:4.4},l:{x:2.5,y:1.5,z:6.4}},{p:{x:3.8,y:1.6,z:6.2},l:{x:2.85,y:1,z:8.4}},
      {p:{x:2.85,y:1.6,z:8.9},l:{x:2.85,y:1,z:11.4}}];
    let i=0;(function n(){if(i>=w.length)return;animCam(w[i].p,w[i].l);i++;setTimeout(n,2500)})();break;
}};

// ============ MINIMAP ============
function drawMinimap(){
  const cv=document.getElementById('minimap'),ctx=cv.getContext('2d'),dpr=2;
  cv.width=cv.offsetWidth*dpr;cv.height=cv.offsetHeight*dpr;ctx.scale(dpr,dpr);
  const cw=cv.offsetWidth,ch=cv.offsetHeight,sc=12,ox=15,oy=ch-8;
  ctx.fillStyle='#0a0a1a';ctx.fillRect(0,0,cw,ch);
  // r2s: maps 3D coords to screen. High z (south/bedroom) = bottom. Low z (north/patio) = top.
  function r2s(x,z){return[ox+x*sc, oy-(MZ-z)*sc]}
  function dR(rx,rz,rw,rd,col,lbl,ls=8){
    const[sx,sy]=r2s(rx,rz),sw=rw*sc,sh=rd*sc;
    ctx.fillStyle=col;ctx.fillRect(sx,sy,sw,sh);
    ctx.strokeStyle='rgba(255,255,255,0.4)';ctx.lineWidth=1.5;ctx.strokeRect(sx,sy,sw,sh);
    ctx.fillStyle='rgba(255,255,255,0.7)';ctx.font=`${ls}px system-ui`;ctx.textAlign='center';
    ctx.fillText(lbl,sx+sw/2,sy+sh/2+3);
  }
  function dD(x,z,w,vert){const[sx,sy]=r2s(x,z);ctx.strokeStyle='#ffcc00';ctx.lineWidth=2;
    if(!vert){ctx.beginPath();ctx.moveTo(sx,sy);ctx.lineTo(sx+w*sc,sy);ctx.stroke()}
    else{ctx.beginPath();ctx.moveTo(sx,sy);ctx.lineTo(sx,sy+w*sc);ctx.stroke()}}
  function dW(x,z,w,vert){const[sx,sy]=r2s(x,z);ctx.strokeStyle='#44aaff';ctx.lineWidth=3;
    if(!vert){ctx.beginPath();ctx.moveTo(sx,sy);ctx.lineTo(sx+w*sc,sy);ctx.stroke()}
    else{ctx.beginPath();ctx.moveTo(sx,sy);ctx.lineTo(sx,sy+w*sc);ctx.stroke()}}
  function h2r(h,a){const r=parseInt(h.slice(1,3),16),g=parseInt(h.slice(3,5),16),b=parseInt(h.slice(5,7),16);return`rgba(${r},${g},${b},${a})`}
  // Building hallway
  const[hx,hy]=r2s(0,BR.z);
  ctx.fillStyle='rgba(150,140,120,0.15)';ctx.fillRect(hx,hy,1.2*sc,4.8*sc);
  ctx.fillStyle='rgba(255,255,255,0.25)';ctx.font='7px system-ui';ctx.textAlign='center';
  ctx.fillText('כניסה',hx+.6*sc,hy+2.4*sc);
  // Rooms
  dR(LV.x,LV.z,LV.w,LV.d,h2r(wallColors.living,.25),'סלון+מטבח',8);
  dR(BR.x,BR.z,BR.w,BR.d,h2r(wallColors.bedroom,.25),'חדר שינה',8);
  dR(PT.x,PT.z,PT.w,PT.d,'rgba(100,140,100,0.2)','פטיו',7);
  dR(TT.x,TT.z,TT.w,TT.d,'rgba(100,100,140,0.2)','שירותים',7);
  dR(BL.x,BL.z,BL.w,BL.d,'rgba(80,130,80,0.12)','מרפסת',7);
  // Doors (yellow)
  dD(0,5.15,.9,true);       // Main door (west wall, vertical)
  dD(3.6,6.6,.8,false);     // Bedroom door (horizontal)
  dD(1.05,1.5,.7,false);    // Patio door (horizontal)
  dD(2.3,0.75,.7,true);     // Patio→toilet (vertical)
  // Windows (blue)
  dW(4.5,3.8,1.2,true);     // Balcony exit
  dW(2.0,11.4,.7,false);    // Bedroom win1
  dW(3.25,11.4,.7,false);   // Bedroom win2
  // Furniture
  furnitureInScene.forEach(f=>{
    const[fx,fy]=r2s(f.position.x,f.position.z);
    const fw=(f.userData.w||.5)*sc,fd=(f.userData.d||.5)*sc;
    ctx.save();ctx.translate(fx,fy);ctx.rotate(-f.rotation.y);
    ctx.fillStyle=f===selectedFurniture?'rgba(99,102,241,0.6)':'rgba(180,170,130,0.4)';
    ctx.fillRect(-fw/2,-fd/2,fw,fd);
    ctx.strokeStyle=f===selectedFurniture?'rgba(99,102,241,0.9)':'rgba(200,200,200,0.3)';
    ctx.lineWidth=.5;ctx.strokeRect(-fw/2,-fd/2,fw,fd);
    ctx.fillStyle='rgba(255,255,255,0.5)';ctx.font='5px system-ui';ctx.textAlign='center';
    ctx.fillText((f.userData.nameHe||'').slice(0,6),0,2);ctx.restore();
  });
  // Camera
  const[cx,cy]=r2s(camera.position.x,camera.position.z);
  ctx.fillStyle='#ff4444';ctx.beginPath();ctx.arc(cx,cy,3,0,Math.PI*2);ctx.fill();
  // Dimensions
  ctx.fillStyle='rgba(255,255,255,0.3)';ctx.font='7px system-ui';ctx.textAlign='center';
  const[l1,ly1]=r2s(0,LV.z+LV.d),[l2]=r2s(4.5,LV.z+LV.d);ctx.fillText('4.5m',(l1+l2)/2,ly1-3);
  const[b1,by1]=r2s(1.2,BR.z+BR.d),[b2]=r2s(4.5,BR.z+BR.d);ctx.fillText('3.3m',(b1+b2)/2,by1+9);
  // Compass
  ctx.fillStyle='rgba(255,255,255,0.25)';ctx.font='8px system-ui';
  const[,ntop]=r2s(2.5,0);ctx.fillText('N ↑',ox+2.5*sc,ntop-5);
  ctx.fillText('STREET (S)',ox+2.5*sc,oy+10);
}

window.togglePanel=()=>{document.getElementById('panel').classList.toggle('collapsed');
  document.getElementById('toggle-panel').classList.toggle('collapsed');
  document.getElementById('toggle-panel').textContent=document.getElementById('panel').classList.contains('collapsed')?'\u25B6':'\u25C0'};
window.addEventListener('resize',()=>{
  camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth,window.innerHeight);
  composer.setSize(window.innerWidth,window.innerHeight);
  ssaoPass.setSize(window.innerWidth,window.innerHeight);
});
let frame=0;
function animate(){requestAnimationFrame(animate);controls.update();composer.render();if(++frame%30===0)drawMinimap()}
animate();drawMinimap();
setTimeout(()=>document.getElementById('instructions').style.opacity='0',5000);
</script>
</body>
</html>
